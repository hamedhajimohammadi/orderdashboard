# راهنمای مهاجرت به aaPanel

این راهنما مراحل انتقال پروژه از سرور فعلی به سرور جدید (aaPanel) را توضیح می‌دهد.

## ۱. تهیه نسخه پشتیبان از دیتابیس (سرور فعلی)
شما باید از دیتابیس فعلی خود که روی `dashboard.pgemshop.com` است یک خروجی (Dump) بگیرید.
اگر دسترسی SSH دارید، دستور زیر را روی **سرور فعلی** اجرا کنید:

```bash
pg_dump "postgres://USER:PASSWORD@HOST:PORT/DB_NAME" > migration_backup.sql
```
*جایگزین مقادیر USER, PASSWORD و... با اطلاعات اتصال دیتابیس واقعی.*

اگر از طریق پنل هاستینگ دسترسی دارید، از بخش **Databases** گزینه **Export** یا **Backup** را انتخاب کنید و فایل `.sql` را دانلود کنید.

## ۲. آماده‌سازی فایل‌های پروژه (در سیستم خودتان)
یک اسکریپت برای فشرده‌سازی فایل‌های سورس آماده کرده‌ایم. در ترمینال VS Code دستور زیر را اجرا کنید:

```bash
cd scripts
chmod +x prepare-deploy.sh
./prepare-deploy.sh
```
این دستور یک فایل `deploy.zip` در پوشه `scripts` (یا روت پروژه) ایجاد می‌کند. این فایل شامل تمام کدهای جدید است.

## ۳. تنظیمات در aaPanel

### الف) نصب پیش‌نیازها
1. وارد aaPanel شوید.
2. به بخش **App Store** بروید.
3. برنامه **PostgreSQL** (نسخه ۱۵ یا بالاتر توصیه می‌شود) را نصب کنید.
4. برنامه **Node.js Version Manager** را نصب کنید و مطمئن شوید نسخه Node 18 یا 20 فعال است.
5. برنامه **PM2 Manager** را نصب کنید.

### ب) ساخت دیتابیس جدید
1. به منوی **Databases** > **PostgreSQL** بروید.
2. دکمه **Add Database** را بزنید.
3. نام دیتابیس (مثلاً `pgem_dashboard`)، یوزر و پسورد را تعیین کنید.
4. پس از ساخت، روی **Import** کلیک کنید و فایل `migration_backup.sql` که در مرحله ۱ گرفتید را آپلود و ایمپورت کنید.

### ج) آپلود پروژه
1. به منوی **Files** بروید.
2. به مسیر `/www/wwwroot` بروید.
3. یک پوشه جدید بسازید (مثلاً `panel.pgemshop.com`).
4. فایل `deploy.zip` را داخل این پوشه آپلود کنید.
5. روی فایل کلیک راست کرده و **Unzip** کنید.

### د) راه‌اندازی پروژه (Node Project)
1. به منوی **Website** > **Node Project** بروید.
2. **Add Node Project** را بزنید:
   - **Path**: مسیر پوشه پروژه را انتخاب کنید.
   - **Name**: `panel-pgemshop`
   - **Run Command**: `npm start`
   - **Port**: پورتی که Next.js شما اجرا می‌شود (معمولا 3000، اگر اشغال است 3001 یا غیره. چون می‌خواهید همزمان با فرانت باشد، مطمئن شوید پورت‌ها تداخل ندارند. فرانت معمولا روی 3000 است، پس برای داشبورد مثلا پورت **3001** را انتخاب کنید و در `package.json` اسکریپت start را به `"start": "next start -p 3001"` تغییر دهید یا از تنظیمات aaPanel پورت را ست کنید).
   - **Domain**: در ابتدا دامنه تستی (مثلاً `test-panel.pgemshop.com`) و سپس دامنه اصلی `panel.pgemshop.com` را وارد کنید.
3. تیک **Install dependencies** را بزنید تا `npm install` خودکار انجام شود.
4. **Submit** را بزنید.

### هـ) تنظیم متغیرهای محیطی (.env)
1. در فایل منیجر aaPanel، داخل پوشه پروژه، یک فایل `.env` بسازید (یا فایل موجود را ویرایش کنید).
2. مقدار `DATABASE_URL` را با اطلاعات دیتابیس جدید (مرحله ۳-ب) تنظیم کنید:
   ```env
   DATABASE_URL="postgresql://DB_USER:DB_PASS@127.0.0.1:5432/DB_NAME?schema=public"
   ```
3. پروژه را از بخش Node Project **ریستارت** کنید.

---
**نکته مهم:** برای اینکه پورت داشبورد تغییر کند تا با فرانت تداخل نداشته باشد، قبل از زیپ کردن، فایل `package.json` را ویرایش کنید:
`"start": "next start -p 3002"` (فرض بر این است که پورت ۳۰۰۰ و ۳۰۰۱ اشغال هستند).
