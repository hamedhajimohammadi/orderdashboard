generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int            @id @default(autoincrement())
  phone_number           String         @unique
  first_name             String?
  last_name              String?
  telegram_chat_id       BigInt?        @unique
  telegram_username      String?
  metadata               Json?          @default("{}")
  total_spent            Decimal        @default(0) @db.Decimal(15, 0)
  orders_count           Int            @default(0)
  diamond_balance        Int            @default(0)
  last_order_date        DateTime?
  created_at             DateTime       @default(now())
  updated_at             DateTime       @updatedAt
  admin_password         String?
  admin_username         String?        @unique
  base_salary            Decimal        @default(0) @db.Decimal(15, 0)
  bonus_rate             Int            @default(0)
  daily_quota            Int            @default(0)
  display_name           String?
  is_banned              Boolean        @default(false)
  last_seen              DateTime?
  is_online              Boolean        @default(false)
  last_active_at         DateTime?
  role                   String         @default("customer")
  worked_seconds_today   Int            @default(0)
  assigned_conversations Conversation[] @relation("ConversationAssignee")
  conversations          Conversation[]
  orders                 Order[]

  @@index([telegram_chat_id])
  @@map("users")
}

model Order {
  id                 Int            @id @default(autoincrement())
  wp_order_id        BigInt         @unique
  order_title        String?
  user_id            Int
  total_amount_gross Decimal        @db.Decimal(15, 0)
  final_payable      Decimal        @db.Decimal(15, 0)
  payment_method     String?
  payment_gate_id    String?
  customer_note      String?
  discount_type      String         @default("none")
  affiliate_code     String?
  affiliate_amount   Decimal        @default(0) @db.Decimal(15, 0)
  coupon_code        String?
  coupon_amount      Decimal        @default(0) @db.Decimal(15, 0)
  loyalty_redeemed   Int            @default(0)
  loyalty_amount     Decimal        @default(0) @db.Decimal(15, 0)
  loyalty_earned     Int            @default(0)
  status             String         @default("pending")
  wp_status          String?
  operator_name      String?
  assigned_at        DateTime?
  completed_at       DateTime?
  snapshot_data      Json?
  created_at         DateTime       @default(now())
  order_date         DateTime
  updated_at         DateTime       @updatedAt
  is_pinned          Boolean        @default(false)
  metadata           Json?          @default("{}")
  conversations      Conversation[]
  logs               OrderLog[]
  user               User           @relation(fields: [user_id], references: [id])

  @@index([affiliate_code])
  @@index([payment_method])
  @@index([order_date])
  @@index([status])
  @@index([operator_name])
  @@map("orders")
}

model OrderLog {
  id          Int      @id @default(autoincrement())
  order_id    Int
  admin_name  String?
  action      String
  old_status  String?
  new_status  String?
  description String?
  created_at  DateTime @default(now())
  order       Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([order_id])
  @@map("order_logs")
}

model Expense {
  id          Int       @id @default(autoincrement())
  title       String
  amount      Decimal   @db.Decimal(15, 0)
  category    String    @default("other")
  type        String    @default("one_time")
  date        DateTime
  due_date    DateTime?
  is_paid     Boolean   @default(true)
  description String?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  @@index([category])
  @@index([date])
  @@map("expenses")
}

model CategoryMargin {
  id             Int      @id @default(autoincrement())
  wc_id          BigInt   @unique
  name           String
  margin_percent Float    @default(0)
  updated_at     DateTime @updatedAt

  @@map("category_margins")
}

model Conversation {
  id          Int       @id @default(autoincrement())
  user_id     Int?
  guest_token String?
  order_id    Int?
  status      String    @default("OPEN")
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  assignee_id Int?
  assignee    User?     @relation("ConversationAssignee", fields: [assignee_id], references: [id])
  order       Order?    @relation(fields: [order_id], references: [id])
  user        User?     @relation(fields: [user_id], references: [id])
  messages    Message[]

  @@index([user_id])
  @@index([guest_token])
  @@index([order_id])
  @@map("conversations")
}

model Message {
  id              Int          @id @default(autoincrement())
  conversation_id Int
  sender          String
  content         String
  is_read         Boolean      @default(false)
  created_at      DateTime     @default(now())
  conversation    Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id])
  @@map("messages")
}
